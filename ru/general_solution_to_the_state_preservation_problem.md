1. Статья описывает общее решение гарантии консистентности при установки нескольких состояний синхронным потоком
с учетом статьи [Проблема консистентности состояний](./state_consistency_problem.md).


# Сокращения

1. S - (simple state) простое состояние без подержки тарнзакций и [идемпотентности](https://ru.wikipedia.org/wiki/%D0%98%D0%B4%D0%B5%D0%BC%D0%BF%D0%BE%D1%82%D0%B5%D0%BD%D1%82%D0%BD%D0%BE%D1%81%D1%82%D1%8C), например:
    1. очереди сообщений (kafka);
    0. внешние сервисы;
    0. базы без идемпотентных проверок, с триггерами или автокоммитом;
    0. журналирование.
0. I - (idempotent state) - состояние с поддержкой идемпотентности:
    1. базы данных;
    0. сервисы;
    0. файлы.
0. T - (transact state) - состояния, поддерживающие транзакционную целостность.
    1. базы данных TSQL.



# Таблица возможных комбинаций

1. Таблица демонстирует возможные комбинации установки состояний в синхронном потоке для гарантированной консистентности.
2. Обязательным условием является гарантия повторяемости вызова потока при любом возможном отказе,
    1. для примера:
        1. Поток получает сообщение из очереди, которая гарантирует повторяемость.
        0. Вызов потока из UI не гарантирует повторяемость события, так как пользователь получив ошибку может не выполнить повторное действие.

|Комбинация| Гарантия | Пример | Последствия |
|-|-|-|-|
|SS        | нет      | Push сообщения в очередь; Write в журнал | Накопление дублей сообщений в очереди |
|SI        | нет      | Commit сообщения очереди; Идемпотентный вызов сервиса | Отсутствие вызова сервиса |
|ST        | нет      | Commit сообщения очереди; Insert в базу | Накопление дублей сообщений в очереди |
|IS        | да       | Insert с предпроверкой в базу; Commit сообщения очереди | Многократные попытки Insert |
|II        | да       | Insert с предпроверкой в базу; Update с предпроверкой в базу | Многократные попытки Insert |
|IT        | да       | Вызов внешнего сервиса; Запись в базу | Многократный вызов внешнего сервиса |
|TS        | нет      | Insert в базу; Push в очередь | Накопление записей в БД |
|TI        | нет      | Insert в базу; Запись с предпроверкой в базу | Накопление записей в БД |
|TT        | да       | Insert в базу; Запись в базу в одной транзакции | Полный откат транзакции |



# Общие правила гарантии сохранения состояний

1. Повторямость вызова при любом отказе в потоке
    1. И идемпотентность предыдущего изменения состояния
        1. ИЛИ изменение всех состояний в единой транзакции.
