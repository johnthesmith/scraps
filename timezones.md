# Точка конверсии момента времени в клиент-серверном приложении

## Вступление
Статья рассматривает проблему и решение универсализации работы множества пользователей с различным часовыми поясами в рамках 
клиент-серверного приложения. Обосновывается тезис необходимости приведением времени исключительно на серверной стороне.

## Определения
+ Foe - зона контролируемая пользователем;
+ Core - зона контролируемая разработчиком;
+ Client - любое приложение (включая веб браузер), размещенное на неподконтрольном разработчику оборудовани;
+ Back - конечное звено формирования пользовательского контента и данных в Core (серверная часть);
+ Back components - перечень средств хранения и обработки данных на стороне Back;
+ TZ - time zone.
+ Rules - правила конверсии пользовательскх моментв времени в принятые на Core, обязательно включая TZ, опционально формат момента времени.

## Ситуация
Предполагаем использование TZ UTC+0 для всех Back и Back Components, вне зависимости от фактического временного пояса оборудования и сервисов.

Предположение избавляет от необходимости сопряжения временных зон на уровне компонентов Back и облегчает задачу управления. 
Является желательным но не обязательным, для рассматриваемой темы. В случае различных TZ для Back Components согласование возлагается на Core.

## Задача
Реализовать гарантированно конролируемую работу Client пользоваетелей в разных часовых поясах в рамках единой Core. 

## Варианты
Рассмотрим два варианта обмена моментом времени из UTC+0 между Core и Client.

![Рассматриваемаые варианты](https://github.com/johnthesmith/scraps/blob/main/images/TimeZoneFrienOrFoe.png)

### A. Rules на Back

*Суть*: Конверсия момента времени осуществляется на стороне Core в Back.

1. Client работает в произвольной таймзоне.
0. Данные с Client на Back присылаются как есть.
0. Back имеет однозначные внутренние правила Rules обработки времени от каждого из клиентов. 
0. Получая от клиента момент времени, Back на основании меющихся правил корректирует присланное клиентом значение времени в UTC+0 и пропускает данные далее в Core.
0. Core работает с моментами времени в UTC+0.
0. Возвращаемые на Client моменты времени корректируются согласно Rules в готовом для исползования на Client виде.
0. Client использует данные на свое усмотрение.

### B. Rules на Client

*Суть*: Конверсия момента врмени осущствляется на стороне Foe, что мотивируется концепцией "Представление данных - вопрос клиента".

1. Client работает в произвольной таймзоне. 
0. Данные от Сlient на Back присылаются с учетом Rule размещенных на клиенте.
0. Back исходит из предположения, что данные валидны и представлены в UTC+0.
0. Core произовдит работу с моментами времени в UTC+0.
0. Моменты времени возвращаютяся на Client в UTC+0.
0. Client получает данные в UTC+0 интерпритирует их на основе локальных Rule в необходимый для представления пользователю вид,
в соответсвии с концепцией "Представление данных - вопрос клиента".

Представленные варианты имеют принципиальное различие, а именно точку конверсии данных в доступный пользователю вид.

*Примечание*: Передача момента времени и таймзоны для **каждого** атомарного акта обмена между Client и Core 
в любую из сторон формально является Ультмативным решением, а метод А -- его частностью при умолчальной TZ+0, 
В его случае Back располагает исчерпывающей и фиксируемой информацией о Rules, однако регулярный обмен TZ требует дополнительных
накладных расходов при реализации, и последующего приведения к используемому виду на каждой из сторон, включая визуальные 
компоненты Client.

### Достоинства варианта А
1. Контролируемость результатов, получаемых конечным пользователем.
0. Core гарантированно выводит себя из под вопросов о результатах интерпритации данных на стороне клиента.
0. Core гарантирует однозначность Rule и исключает непроверяемое влияние User.
0. Core имеет возможность доказать и продемонстрировать валидность и целостность данных.
0. Изменение Rules могут быть выполнены исключительно через информирмирование Core.
0. Полностью освобождает разработчика клиентской часть от необходимости интерпритации данных, как при получении так и при отправке.
Клиент работает с представленным временем и информируется о Rules однократно или при их смене.

### Недостатки варианта Б
Ниже перечисленные недостатки не зависят от источника Rules на клиенте. 
Все справедливо как для случаев использования настроек локального рабочего места, так и для присылаемых с Core.
Оценивать место расположения точки конверсии необходимо исключительно из позиции "Клиент находится в руказ врага". 

1. Так как Rules расположениы на неподконтрольной территории, они могут быть намерянно или случайно искажены.
0. Core не имеет пркатической возможности подтвердить или опровергнуть внесенные изменения.
0. Соre вынуждена доверять полученным данным и использовать их на совоей стороне как истиные.
0. Передача Rule не гарантирует их целостность.
0. Выше перечисленное справедливо как для поступающих данных в Core так и для использования их на сторе Client.

### Источники искажения Rules на Client
1. Непреднамеренная ошибка настройки TZ;
0. Непреднамеренная ошибка перевода зимнего-летнего времени;
0. Преднамеренное внесение искажений в парамтры TZ и формат момента времени;
0. Преднамеренное искажение момента времени пользуясь неоднозначностью форматов при кратковременном внесении изменения в формат момента времени.

### Примеры инцидентов при реализации варианта Б
1. Core ожидает момент времени для фиксации времени, водимого оператором. Оператор преднамеренно изменяет TZ, 
но при этом вводит корректное время с точки зрения клиентского приложения. Момент интерпритируется Client с учетом искаженной TZ. 
В результате с точки зрения визуальной части ввод оператора коректен, но Core получило искаженное время. Доказать подобное изменение со стороны Core невозможно.
0. Не для всех пользователей контрольной группы осуществлен перевод зимнего-летнего времени по различным внешним причинам. 
Пользователи одномомоментно вводят корректное и одинаковое время, но Core получает различное смещение времени из за различных настроек перехода на летнее-зимнее время.
0. Пользователь перемещается между часовыми поясами и изменяет настройки времени на своем рабочем устройстве в соответсвии с местом пребывания. 
При этом изменяются результаты отправляемые (получаемые) при взаимодействии с Core. Подобное поведение за частую неприемлимо для финансовых приложений.
   
### Выводы
1. Из вариантов A cчитаю предпочтительным к реализации в распределенной системе для пользователей в различных часовых поясах.
0. Вариант Б содержит концептуальные недостатки, компенсируемые реализацией лишь частично.
0. Вариант А не нарушает принципа "представлени данных - вопрос клиента", так как Rules является элементом бизнес-логики. 
0. Формат представления момента времени для каждого пользователя так же может являются элементом бизнес-логики, 
и в этом случае не может устанавливаться Client, так как зависит от полномочий пользователя и трбеуемого функционала.
Бесконтрольный доступ к изменению формата открывает массу возможностей манипуляции данными (в частоности на печатных формах).
0. Даже при полной передаче момента времени как подготовленной строки в необходимом формате c учетом пользовательской TZ может
может быть исключительно рекомендательной, или не осуществляться вовсе. Данные передаются как есть, а их расхождение с 
настройками Client являются проблемой Client.



